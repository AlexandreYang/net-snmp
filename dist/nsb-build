#!/bin/bash
#
# $Id$
# Author: Robert Story <rstory@freesnmp.com>
#
########################################################################
########################################################################

usage()
{
   echo "Usage: $0  [-c] [-d] [-p] [-s SRCD] [-b BUILDD] [-i INSTALLD] VERSION"
   echo " VERSION   : relase number (eg 5.0.3)"
   echo " -s SRCDIR  : soure directory [$HOME/src/net-snmp-VERSION]"
   echo " -b BUILDD  : build directory [$HOME/build/`nsb-sysname`]"
   echo " -i INSTALLD: install directory [$HOME/build/`nsb-sysname`/usr/local]"
   echo " -c : skip configure step"
   echo " -d : dirty build (don't make distclean)"
   echo " -p : don't pause at prompts in between stages"
   exit 1
}

#set -x

if [ ! -f nsb-functions ];then
   echo "Cannot find nsb-functions"
   exit 1
fi

source nsb-functions

########################################################################
########################################################################

VERSION=$1
SRCD=$HOME/src/net-snmp-$VERSION
BUILDD=$HOME/build/`nsb-sysname`
INSTALLD=$HOME/build/`nsb-sysname`/usr/local

#      x)  x=$OPTARG ;;
while getopts b:cdi:ps: opt
do
    case "$opt" in
      b)  BUILDD=$OPTARG ;;
      c)  NSB_SKIP_CONFIG=1 ;;
      d)  NSB_CLEAN=0 ;;
      i)  INSTALLD=$OPTARG ;;
      p)  NSB_PROMPT=0 ;;
      s)  SRCD=$OPTARG ;;
      \?)# unknown flag
        usage;;
    esac
done
shift `expr $OPTIND - 1`

if [ $# -ne 1 ]; then
   echo "expecting 1 argument, got $# ($@)"
   usage
fi

if [ $NSB_CLEAN -eq 1 ]; then
   if [ $NSB_SKIP_CONFIG -eq 1 ]; then
      echo "A clean build also requires configuration (-d and -c"
      echo "cannot both be specified)."
      usage
   fi
fi

########################################################################
########################################################################

#nsb-prompt "press enter to build $SRCD in $BUILDD, and install in $INSTALLD"
nsb-build $VERSION $SRCD $BUILDD $INSTALLD

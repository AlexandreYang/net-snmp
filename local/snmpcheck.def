#!/usr/local/bin/perl -w

#defaults
$hostname=`hostname`;
$mibident=".2";
$miberrflag=".100";
$miberrmsg=".101";
$mibfix=".102";
$mibheadsht=".1.3.6.1.4";
$mibheadall="$mibheadsht.10";
@miblist=(".1",".3",".4",".6");
@fixitlist=(".1",".3");
$errlog="/net/tyfon/1/OV/log/ece-log";
$andlog=0;
$snmppath="/usr/local/etc";
$eraseline="                                                                           \r";
$fixit=-1;  # this should be 0 not -1, but is necissary till getc(STDIN) works

while ($_ = $ARGV[0], /^-/) {
    shift;
    /^-a/ && ($andlog = 1);
    /^-n/ && ($fixit = -1);
    /^-y/ && ($fixit = 1);
}

if ($andlog || $#ARGV == -1) {
    open(LOG,$errlog);
    while (<LOG>) {
	@fields = split;
	@tmp = grep(/$fields[0]/,@ARGV);
	if ($#tmp == -1 && $fields[1] ne "down") {
	    @ARGV[$#ARGV + 1] = $fields[0];
	}
    }
    close(LOG);
}

select(STDOUT);
$| = 1;
foreach $host ( @ARGV ) {
    foreach $mibx ( @miblist ) {
	$mibcheck="$mibheadall$mibx";
	printf "%sChecking %s: %s\r", $eraseline,$host,$mibcheck;
	open(OUT,"$snmppath/snmpwalk -v 1 $host public $mibcheck$miberrflag|");
	while (<OUT>) {
	    ($mibloc) = /\.([0-9]+) /;
	    if (($succ = &check_mib($_,1)) != 0 && 
		($hostname =~ /tyfon/) && grep(/$mibx/,@fixitlist) &&
		$fixit >= 0) {
		printf(" / Fixing...\b\b\b\b\b\b\b\b\b");
		system("snmpset $host $mibcheck$mibfix.$mibloc integer 1 > /dev/null 2>&1");
		sleep(1);
		if (($succ = &check_mib($mibcheck,0)) != 0) {
		    printf("*failed*  \n");
		}
		else {
		    printf("Fixed     \n");
		}
	    }
	    elsif ($succ != 0) {
		printf("\n");
	    }
	}
	close(OUT);
    } 
}
printf("$eraseline");

sub check_mib {
    local($mib) = shift;
    local($report) = shift;
    if ($mib =~ /^(\.[0-9]+)+$/) {
	$_ = `$snmppath/snmpget -v 1 $host public $mib$miberrflag.$mibloc`;
    }
    ($result) = /= ([0-9]+)/;
    if ($result > 0 && $report) {
	$_ = `$snmppath/snmpget -v 1 $host public $mibcheck$mibident.$mibloc`;
	($procname) = /\"([^\"]*)\"/;
	$_ = `$snmppath/snmpget -v 1 $host public $mibcheck$miberrmsg.$mibloc`;
	($errmsg) = /\"([^\"]*)\"/;
	printf("%s%-8.8s  %-12.12s  %2d -- %-37.37s",$eraseline,$host,
	       $procname,$result,$errmsg);
    }
    $result;
}

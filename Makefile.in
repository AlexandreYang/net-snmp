#
# Makefile.in (at the root of ucd-snmp)
#

top_builddir	= .

SUBDIRS		= snmplib agent apps local man mibs
TESTDIRS	= testing

CPP		= @CPP@ 					        \
		-Iinclude -I$(srcdir)/agent/mibgroup -I. -I$(srcdir)	\
		-DDONT_INC_STRUCTS -DBINDIR=$(bindir) 		        \
		$(EXTRACPPFLAGS)

INSTALLHEADERS=net-snmp-config.h version.h
INCLUDESUBDIRHEADERS=mib_module_config.h
INCLUDESUBDIR=agent
INSTALLBINPROGS=net-snmp-config
INSTALLUCDHEADERS=ucd-snmp-config.h version.h mib_module_config.h

#
# perl specific
#
PERLMODULES=SNMP ASN default_store agent

all:    sedscript EXAMPLE.conf standardall @PERLTARGS@ 


#
# local build rules
#
sedscript: sedscript.in include/net-snmp/net-snmp-config.h $(srcdir)/agent/mibgroup/mibdefs.h
	$(CPP) -DPREFIX=$(prefix) -DLIBDIR=$(libdir) -DDATADIR=$(datadir) $(srcdir)/sedscript.in | egrep '^s[/#]' | sed 's/REMOVEME//g;s# */#/#g;s/ *#/#/g;s#/ *#/#g;s/# g/#g/;' > sedscript

EXAMPLE.conf: sedscript EXAMPLE.conf.def
	$(SED) -f sedscript $(srcdir)/EXAMPLE.conf.def > EXAMPLE.conf

docs: doxygen.conf
	doxygen doxygen.conf

#
# test targets
#
test: all testdirs
	( cd testing; $(MAKE) test )

testdirs:
	for i in $(TESTDIRS) ; do	\
        ( cd $$i ; $(MAKE) ) ;		\
	done

distall: ${srcdir}/configure ${srcdir}/include/net-snmp/net-snmp-config.h 

OTHERCLEANTARGETS="EXAMPLE.conf sedscript perlclean"

#
# perl specific build rules
#
perlmodules:
	@for i in $(PERLMODULES); do \
	   if test ! -f perl/$$i/Makefile; then \
		(cd perl/$$i ; perl Makefile.PL INC=-I../../include INST_LIB=../blib/lib INST_ARCHLIB=../blib/arch) ; \
	   fi ; \
	   (cd perl/$$i ; $(MAKE)) ; \
	done

perlclean:
	@for i in $(PERLMODULES); do \
	 ( cd perl/$$i ; $(MAKE) clean ) ; \
	done

#
# make distclean completely removes all traces of building including
# any files generated by configure itself.
#
distclean: clean configclean

makefileclean:
	rm -f Makefile snmplib/Makefile				\
		agent/Makefile agent/mibgroup/Makefile		\
		agent/helpers/Makefile				\
		apps/Makefile  apps/snmpnetstat/Makefile	\
		man/Makefile mibs/Makefile ov/Makefile		\
		local/Makefile testing/Makefile

configclean: makefileclean
	rm -f config.cache config.status config.log \
		libtool include/net-snmp/net-snmp-config.h
	rm -f mibs/.index
	rm -f include/net-snmp/agent/mib_module_config.h		\
		snmplib/snmpsm_init.h                   \
		agent/mibgroup/mib_module_includes.h 	\
		agent/mibgroup/mib_module_inits.h 	\
		agent/mibgroup/mib_module_shutdown.h 	\
		agent/mibgroup/mib_module_dot_conf.h
	rm -f *.core

#
# Configure script related targets
#
touchit:
	touch configure include/net-snmp/net-snmp-config.h.in
	touch config.status
	touch stamp-h stamp-h.in

Makefile: Makefile.in config.status Makefile.rules Makefile.top
	CONFIG_HEADERS= ./config.status

$(srcdir)/include/net-snmp/net-snmp-config.h.in: stamp-h.in
$(srcdir)/stamp-h.in: configure.in acconfig.h
	cd ${srcdir} && LC_COLLATE=C $(AUTOHEADER)
	echo timestamp > ${srcdir}/stamp-h.in

include/net-snmp/net-snmp-config.h: stamp-h
stamp-h: include/net-snmp/net-snmp-config.h.in config.status
	CONFIG_FILES= ./config.status
	echo timestamp > stamp-h

$(srcdir)/configure: configure.in aclocal.m4
	cd ${srcdir} && $(AUTOCONF)
	echo "Please run configure now."
	sh -c exit 2

config.status: configure
	./config.status --recheck

#
# Emacs TAGS file
#
TAGS:
	find $(srcdir) -name '*.[ch]' -print | etags -

#
# Internal distribution packaging, etc.
#
version:
	@if test "x$(VERSION)" = "x"; then \
	  echo "you need to supply a VERSION string."; \
	  exit 2; \
	fi
	agent/mibgroup/versiontag $(VERSION) reverse

tag:
	agent/mibgroup/versiontag $(VERSION) tag

tar:
	agent/mibgroup/versiontag $(VERSION) tar

dist: version tag tar

FAQ.html:
	local/FAQ2HTML FAQ

.PHONY: docs testdirs test TAGS
# note: tags and docs are phony to force rebulding

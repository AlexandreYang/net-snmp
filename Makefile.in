#
# Makefile.in (at the root of ucd-snmp)
#

top_builddir	= .
TARG		=	bin/snmpget$(EXEEXT) bin/snmpgetnext$(EXEEXT) bin/snmpset$(EXEEXT) 	\
			bin/snmptranslate$(EXEEXT) bin/snmpwalk$(EXEEXT) bin/snmpbulkwalk$(EXEEXT) \
			bin/snmptest$(EXEEXT) bin/snmptrapd$(EXEEXT) bin/snmpnetstat$(EXEEXT) bin/snmpd$(EXEEXT)

SUBDIRS		= snmplib agent apps local ov man
INSTALLDIRS	= snmplib agent apps local man mibs
TESTDIRS	= testing

CPP		= @CPP@ 					        \
		-Iinclude -I$(srcdir)/agent/mibgroup -I. -I$(srcdir)	\
		-DDONT_INC_STRUCTS -DBINDIR=$(bindir) 		        \
		$(EXTRACPPFLAGS)

INSTALLUCDHEADERS=ucd-snmp-config.h $(srcdir)/version.h mib_module_config.h
INSTALLHEADERS=include/net-snmp/net-snmp-config.h $(srcdir)/version.h mib_module_config.h
INSTALLSCRIPTS=net-snmp-config

# perl specific
PERLMODULES=SNMP ASN default_store agent

all:	sedscript EXAMPLE.conf subdirs @PERLTARGS@

test:   all
	( cd testing; $(MAKE) test )

sedscript: sedscript.in include/net-snmp/net-snmp-config.h $(srcdir)/agent/mibgroup/mibdefs.h
	$(CPP) -DPREFIX=$(prefix) -DLIBDIR=$(libdir) -DDATADIR=$(datadir) $(srcdir)/sedscript.in | egrep '^s[/#]' | sed 's/REMOVEME//g;s# */#/#g;s/ *#/#/g;s#/ *#/#g;s/# g/#g/;' > sedscript


subdirs:
	for i in $(SUBDIRS) ; do	\
        ( cd $$i ; $(MAKE) ) ;		\
	done


test: all testdirs

testdirs:
	for i in $(TESTDIRS) ; do	\
        ( cd $$i ; $(MAKE) ) ;		\
	done


distall: ${srcdir}/configure ${srcdir}/include/net-snmp/net-snmp-config.h 

docs: doxygen.conf
	doxygen doxygen.conf

install:    all installdirs
	for i in $(INSTALLDIRS) ; do	\
        ( cd $$i ; $(MAKE) install ) ;	\
	done
	@$(INSTALL) $(INSTALLHEADERS) $(includedir)
	@$(INSTALL) $(INSTALLUCDHEADERS) $(ucdincludedir)
	@$(INSTALL) $(INSTALLSCRIPTS) $(bindir)
	@for i in $(INSTALLHEADERS) ; do \
		echo "install:  installed $$i in $(includedir)";\
	done

installdirs:
	@$(SHELL) $(srcdir)/mkinstalldirs $(snmplibdir) $(mibdir) $(includedir)
	@-$(SHELL) $(srcdir)/mkinstalldirs $(persistentdir)

apps/snmpget$(EXEEXT) apps/snmpgetnext$(EXEEXT) apps/snmpset$(EXEEXT) apps/snmptranslate$(EXEEXT) apps/snmpwalk$(EXEEXT) apps/snmpbulkwalk$(EXEEXT) apps/snmptest$(EXEEXT) apps/snmptrapd$(EXEEXT) apps/snmpnetstat/snmpnetstat$(EXEEXT) agent/snmpd$(EXEEXT): makeall


depend:
	cd snmplib; $(MAKE) depend
	cd apps; $(MAKE) depend
	cd agent; $(MAKE) depend
	cd testing; $(MAKE) depend

nosysdepend:
	cd snmplib; $(MAKE) nosysdepend
	cd apps; $(MAKE) nosysdepend
	cd agent; $(MAKE) nosysdepend
	cd testing; $(MAKE) nosysdepend

makefileindepend:
	cd snmplib; $(MAKE) makefileindepend
	cd apps; $(MAKE) makefileindepend
	cd agent; $(MAKE) makefileindepend
	cd testing; $(MAKE) makefileindepend

perlmodules:
	for i in $(PERLMODULES); do \
           (cd perl/$$i ; perl Makefile.PL INC=-I../../include INST_LIB=../blib/lib INST_ARCHLIB=../blib/arch; $(MAKE)) \
	done

clean:
	for i in $(SUBDIRS) $(TESTDIRS); do \
        ( cd $$i ; $(MAKE) clean ) ; \
	done
	for i in $(PERLMODULES); do \
        ( cd perl/$$i ; $(MAKE) clean ) ; \
	done
	rm -f EXAMPLE.conf sedscript ucd-snmp.txt

distclean: clean configclean

makefileclean:
	rm -f Makefile snmplib/Makefile				\
		agent/Makefile agent/mibgroup/Makefile		\
		agent/helpers/Makefile				\
		apps/Makefile  apps/snmpnetstat/Makefile	\
		man/Makefile mibs/Makefile ov/Makefile		\
		local/Makefile testing/Makefile

configclean: makefileclean
	rm -f config.cache config.status config.log \
		libtool include/net-snmp/net-snmp-config.h
	rm -f mibs/.index
	rm -f mib_module_config.h 			\
		snmplib/snmpsm_init.h                   \
		agent/mibgroup/mib_module_includes.h 	\
		agent/mibgroup/mib_module_inits.h 	\
		agent/mibgroup/mib_module_shutdown.h 	\
		agent/mibgroup/mib_module_dot_conf.h
	rm -f *.core


$(srcdir)/configure: configure.in aclocal.m4
	cd ${srcdir} && $(AUTOCONF)
	echo "Please run configure now."
	sh -c exit 2


# autoheader might not change include/net-snmp/net-snmp-config.h.in, so touch a stamp file.
#
$(srcdir)/include/net-snmp/net-snmp-config.h.in: stamp-h.in
$(srcdir)/stamp-h.in: configure.in acconfig.h
	cd ${srcdir} && LC_COLLATE=C $(AUTOHEADER)
	echo timestamp > ${srcdir}/stamp-h.in

include/net-snmp/net-snmp-config.h: stamp-h
stamp-h: include/net-snmp/net-snmp-config.h.in config.status
	CONFIG_FILES= ./config.status
	echo timestamp > stamp-h

touchit:
	touch configure include/net-snmp/net-snmp-config.h.in
	touch config.status
	touch stamp-h stamp-h.in

Makefile: Makefile.in config.status
	CONFIG_HEADERS= ./config.status

config.status: configure
	./config.status --recheck

EXAMPLE.conf: sedscript EXAMPLE.conf.def
	$(SED) -f sedscript $(srcdir)/EXAMPLE.conf.def > EXAMPLE.conf

TAGS:
	find $(srcdir) -name '*.[ch]' -print | etags -

version:
	@if test "x$(VERSION)" = "x"; then \
	  echo "you need to supply a VERSION string."; \
	  exit 2; \
	fi
	agent/mibgroup/versiontag $(VERSION) reverse

tag:
	agent/mibgroup/versiontag $(VERSION) tag

tar:
	agent/mibgroup/versiontag $(VERSION) tar

dist: version tag tar

FAQ.html:
	local/FAQ2HTML FAQ

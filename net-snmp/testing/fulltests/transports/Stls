#!/bin/sh

NSCERT="perl $SNMP_BASEDIR/../../../local/net-snmp-cert"
NSCERTARGS="-C $SNMP_TMPDIR"

# produce the certificates to use

# snmpd
$NSCERT gencert -t snmpd   --cn `hostname` $NSCERTARGS > /dev/null 2>&1
SERVERFP=`$NSCERT showcerts --fingerprint snmpd  $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user
$NSCERT gencert -t snmpapp --cn 'testuser'  $NSCERTARGS > /dev/null 2>&1
TESTUSERFP=`$NSCERT showcerts --fingerprint snmpapp $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 2
$NSCERT gencert -t otheruser --cn 'otheruser'  $NSCERTARGS > /dev/null 2>&1
OTHERUSERFP=`$NSCERT showcerts --fingerprint otheruser $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 3
$NSCERT gencert -t invaliduser --cn 'invaliduser'  $NSCERTARGS > /dev/null 2>&1
INVALIDUSERFP=`$NSCERT showcerts --fingerprint invaliduser $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 4
$NSCERT gencert -t unmapped --cn 'unmapped'  $NSCERTARGS > /dev/null 2>&1
UNMAPPEDFP=`$NSCERT showcerts --fingerprint unmapped $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 5
$NSCERT gencert -t mappeduser --cn 'mappeduser'  $NSCERTARGS > /dev/null 2>&1
MAPPEDUSERFP=`$NSCERT showcerts --fingerprint mappeduser $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 6: SAN email
$NSCERT gencert -t email --san email:foobaruser@example.com  $NSCERTARGS > /dev/null 2>&1
EMAILUSERFP=`$NSCERT showcerts --fingerprint email $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 7: SAN dns
$NSCERT gencert -t dns --san DNS:foobar.example.com  $NSCERTARGS > /dev/null 2>&1
DNSUSERFP=`$NSCERT showcerts --fingerprint dns $NSCERTARGS | grep Finger | sed 's/.*=//'`

# user 8: SAN IPv4
$NSCERT gencert -t ipaddr --san IP:127.0.0.1  $NSCERTARGS > /dev/null 2>&1
IPUSERFP=`$NSCERT showcerts --fingerprint ipaddr $NSCERTARGS | grep Finger | sed 's/.*=//'`


CONFIGAGENT '[snmp]' debugTokens tsm
CONFIGAGENT '[snmp]' doDebugging 1
CONFIGAGENT '[snmp]' defX509ServerPub $SERVERFP

# common name mappings
CONFIGAGENT certSecName 10 $TESTUSERFP     --cn
CONFIGAGENT certSecName 11 $OTHERUSERFP    --cn
CONFIGAGENT certSecName 12 $INVALIDUSERFP  --cn

CONFIGAGENT certSecName 20 $MAPPEDUSERFP --sn aftermapping
CONFIGAGENT certSecName 21 $EMAILUSERFP  --rfc822
CONFIGAGENT certSecName 22 $DNSUSERFP    --dns
CONFIGAGENT certSecName 23 $IPUSERFP     --ip

# *** INTENTIONALLY NOT MAPPING AT ALL: ***
# CONFIGAGENT certSecName 1000 $UNMAPPEDFP ....

$NSCERT showcerts --fingerprint snmpapp $NSCERTARGS | grep Finger | sed 's/.*=//'
CONFIGAPP   defX509ClientPub  	  $TESTUSERFP
CONFIGAPP   defX509ServerPub  	  $SERVERFP
CONFIGAPP   defSecurityModel      tsm

# CONFIGAPP   AllowSelfSignedX509 1

CONFIGAGENT  rwuser -s tsm testuser authpriv
CONFIGAGENT  rwuser -s tsm otheruser authpriv
CONFIGAGENT  rwuser -s tsm aftermapping authpriv

CONFIGAGENT  rwuser -s tsm foobaruser@example.com authpriv
CONFIGAGENT  rwuser -s tsm foobar.example.com authpriv
CONFIGAGENT  rwuser -s tsm 127.0.0.1 authpriv
